<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ödeal Mail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ekranın tamamını kaplaması ve kaydırma çubuklarının yönetimi için */
        html, body {
            height: 100%;
            overflow: hidden;
        }
        /* Mesaj listesi ve okuma panelinin kaydırılabilir olması için */
        .scrollable {
            overflow-y: auto;
            max-height: calc(100vh - 4rem); /* Ekran yüksekliğinden başlık yüksekliğini çıkar */
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div id="app" class="flex h-screen">
        <!-- Sol Panel: Kullanıcı Seçimi ve Gelen Kutusu -->
        <aside class="w-1/3 bg-white border-r border-gray-200 flex flex-col scrollable">
            <!-- Başlık ve Kullanıcı Seçimi -->
            <header class="p-4 border-b">
                <h1 class="text-xl font-bold text-gray-800">Ödeal Mail</h1>
                <div class="mt-4">
                    <label for="user-select" class="text-sm font-medium text-gray-600">Giriş Yapan Kullanıcı:</label>
                    <select id="user-select" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                        <!-- Kullanıcılar buraya dinamik olarak eklenecek -->
                    </select>
                </div>
            </header>

            <!-- Gelen Kutusu -->
            <div id="inbox" class="flex-grow p-2">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-lg font-semibold text-gray-700">Gelen Kutusu</h2>
                    <button id="refresh-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M20 4s-2-2-6-2-6 2-6 2s-2 2-2 6 2 6 2 6 2 2 6 2 6-2 6-2 2-2 2-6-2-6-2-6z" /></svg>
                    </button>
                </div>
                <div id="message-list" class="space-y-2">
                    <!-- Mesajlar buraya dinamik olarak eklenecek -->
                </div>
            </div>
        </aside>

        <!-- Sağ Panel: Mesaj Okuma ve Yazma -->
        <main class="w-2/3 flex flex-col bg-gray-50 scrollable">
            <div id="message-view" class="p-6 flex-grow">
                <!-- Seçili mesaj burada gösterilecek -->
                <div class="text-center text-gray-500 pt-20">Okumak için bir mesaj seçin veya yeni bir mesaj oluşturun.</div>
            </div>
            
            <!-- Yeni Mesaj Oluşturma Formu -->
            <div id="compose-view" class="p-4 bg-white border-t border-gray-200">
                <h3 class="text-lg font-semibold mb-2 text-gray-800">Yeni Mesaj</h3>
                <form id="compose-form">
                    <div class="mb-2">
                        <label for="compose-to" class="sr-only">Alıcı:</label>
                        <select id="compose-to" class="w-full p-2 border border-gray-300 rounded-md" required>
                            <!-- Alıcılar buraya eklenecek -->
                        </select>
                    </div>
                    <div class="mb-2">
                        <label for="compose-subject" class="sr-only">Konu:</label>
                        <input type="text" id="compose-subject" placeholder="Konu" class="w-full p-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div class="mb-2">
                        <label for="compose-body" class="sr-only">Mesaj:</label>
                        <textarea id="compose-body" rows="6" placeholder="Mesajınızı buraya yazın..." class="w-full p-2 border border-gray-300 rounded-md" required></textarea>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Gönder</button>
                    </div>
                </form>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- AYARLAR ---
            // BU ADRESİ CANLIYA ÇIKARKEN DEĞİŞTİRMEYİ UNUTMA!
            const API_URL = 'http://127.0.0.1:8000'; 

            // Elementleri seç
            const userSelect = document.getElementById('user-select');
            const messageList = document.getElementById('message-list');
            const messageView = document.getElementById('message-view');
            const composeForm = document.getElementById('compose-form');
            const composeTo = document.getElementById('compose-to');
            const refreshBtn = document.getElementById('refresh-btn');

            let allUsers = [];
            let currentUserEmail = '';

            // --- FONKSİYONLAR ---

            // 1. Tüm kullanıcıları API'den çek ve seçim kutularını doldur
            async function populateUsers() {
                try {
                    const response = await fetch(`${API_URL}/users`);
                    allUsers = await response.json();

                    userSelect.innerHTML = '';
                    composeTo.innerHTML = '<option value="">Alıcı Seçin...</option>';

                    allUsers.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.email;
                        option.textContent = user.name;
                        userSelect.appendChild(option);

                        const recipientOption = option.cloneNode(true);
                        composeTo.appendChild(recipientOption);
                    });
                    
                    // İlk kullanıcıyı varsayılan olarak ayarla
                    if(allUsers.length > 0) {
                        currentUserEmail = allUsers[0].email;
                        fetchMessages();
                    }
                } catch (error) {
                    console.error('Kullanıcılar çekilirken hata:', error);
                    alert('API sunucusuna bağlanılamadı. Sunucunun çalıştığından emin olun.');
                }
            }

            // 2. Seçili kullanıcının mesajlarını çek
            async function fetchMessages() {
                if (!currentUserEmail) return;

                messageList.innerHTML = '<div class="text-center text-gray-500 p-4">Yükleniyor...</div>';
                try {
                    const response = await fetch(`${API_URL}/messages/${currentUserEmail}`);
                    const data = await response.json();
                    displayMessages(data.messages);
                } catch (error) {
                    console.error('Mesajlar çekilirken hata:', error);
                    messageList.innerHTML = '<div class="text-center text-red-500 p-4">Mesajlar yüklenemedi.</div>';
                }
            }

            // 3. Mesajları gelen kutusunda göster
            function displayMessages(messages) {
                messageList.innerHTML = '';
                if (messages.length === 0) {
                    messageList.innerHTML = '<div class="text-center text-gray-500 p-4">Gelen kutunuz boş.</div>';
                    return;
                }
                
                // Mesajları en yeniden en eskiye doğru sırala
                messages.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                messages.forEach(msg => {
                    const div = document.createElement('div');
                    div.className = 'p-3 rounded-lg cursor-pointer hover:bg-indigo-50 border-b';
                    div.innerHTML = `
                        <div class="font-semibold text-gray-800">${msg.sender_name}</div>
                        <div class="text-sm text-gray-600 truncate">${msg.subject}</div>
                    `;
                    div.addEventListener('click', () => displayMessageContent(msg));
                    messageList.appendChild(div);
                });
            }
            
            // 4. Seçilen mesajın içeriğini sağ panelde göster
            function displayMessageContent(msg) {
                messageView.innerHTML = `
                    <h2 class="text-2xl font-bold text-gray-900 border-b pb-4">${msg.subject}</h2>
                    <div class="flex items-center justify-between mt-4">
                        <p class="text-sm font-semibold text-gray-700">Kimden: ${msg.sender_name}</p>
                        <p class="text-sm text-gray-500">${new Date(msg.timestamp).toLocaleString('tr-TR')}</p>
                    </div>
                    <div class="mt-6 text-gray-800 whitespace-pre-wrap">${msg.content}</div>
                `;
            }

            // 5. Yeni mesaj gönderme
            async function sendMessage(event) {
                event.preventDefault();
                
                const receiverEmail = composeTo.value;
                const subject = document.getElementById('compose-subject').value;
                const content = document.getElementById('compose-body').value;

                if (!receiverEmail) {
                    alert('Lütfen bir alıcı seçin.');
                    return;
                }

                const messageData = {
                    sender_email: currentUserEmail,
                    receiver_email: receiverEmail,
                    subject: subject,
                    content: content
                };

                try {
                    const response = await fetch(`${API_URL}/messages`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(messageData)
                    });

                    if (response.ok) {
                        alert('Mesaj başarıyla gönderildi!');
                        composeForm.reset();
                        // Alıcı kendi ise gelen kutusunu yenile
                        if (receiverEmail === currentUserEmail) {
                            fetchMessages();
                        }
                    } else {
                        const errorData = await response.json();
                        alert(`Mesaj gönderilemedi: ${errorData.detail}`);
                    }
                } catch (error) {
                    console.error('Mesaj gönderilirken hata:', error);
                    alert('Sunucuya bağlanırken bir hata oluştu.');
                }
            }


            // --- OLAY DİNLEYİCİLERİ ---
            userSelect.addEventListener('change', (e) => {
                currentUserEmail = e.target.value;
                messageView.innerHTML = '<div class="text-center text-gray-500 pt-20">Okumak için bir mesaj seçin veya yeni bir mesaj oluşturun.</div>';
                fetchMessages();
            });

            refreshBtn.addEventListener('click', fetchMessages);
            composeForm.addEventListener('submit', sendMessage);

            // --- BAŞLANGIÇ ---
            populateUsers();
        });
    </script>
</body>
</html>